<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
<script type="text/javascript">
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?ae11d5a19bdcf766771692d64967eeb1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

  

  
  <title>老Zhang博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="云计算&#x2F;编程语言&#x2F;数据库&#x2F;容器化&#x2F;虚拟化">
<meta property="og:type" content="website">
<meta property="og:title" content="老Zhang博客">
<meta property="og:url" content="https://blog.kubestack.cn/page/2/index.html">
<meta property="og:site_name" content="老Zhang博客">
<meta property="og:description" content="云计算&#x2F;编程语言&#x2F;数据库&#x2F;容器化&#x2F;虚拟化">
<meta property="og:locale">
<meta property="article:author" content="Tonyzhang1989">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="老Zhang博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="https://fonts.lug.ustc.edu.cn/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="google-site-verification" content="XkIGmrbqh5J83cILz5wx9StkgaQzjhGx0UfHTxlma00" />

<meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">老Zhang博客</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://blog.kubestack.cn"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-kata-Kata-Container介绍" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/10/13/kata-Kata-Container%E4%BB%8B%E7%BB%8D/" class="article-date">
  <time datetime="2021-10-13T07:28:47.000Z" itemprop="datePublished">2021-10-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/10/13/kata-Kata-Container%E4%BB%8B%E7%BB%8D/">kata-Kata Container介绍</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>关于kata的介绍，网上资料很多，过大的官方话就不说了，下面说一些白话一点的，让小白能快速了解的。</p>
<h4 id="1-首先kata是什么"><a href="#1-首先kata是什么" class="headerlink" title="1. 首先kata是什么"></a>1. 首先kata是什么</h4><p>kata 本质上是和runc 平级的，不同的是runc启动的是容器，而kata 启动的是hypervisor(qemu-kvm/firecraker等)，因为公有云上安全性问题，所以衍生出了kata<br><img src="/images/kata/kata-k8s.jpg" alt="img"></p>
<h4 id="2-kata-架构是什么样子的"><a href="#2-kata-架构是什么样子的" class="headerlink" title="2. kata 架构是什么样子的"></a>2. kata 架构是什么样子的</h4><p>kata 为了实现安全性，在容器外层包了一层虚拟化hypervisor(这里以qemu-kvm为例)，从而实现了隔离，安全性更高</p>
<p><img src="/images/kata/jiagou.png" alt="img"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.kubestack.cn/2021/10/13/kata-Kata-Container%E4%BB%8B%E7%BB%8D/" data-id="ckup7kegx0000uc16g0oghjm4" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kata/" rel="tag">kata</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-openstack-cinder-nvmf-target-测试" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/10/13/openstack-cinder-nvmf-target-%E6%B5%8B%E8%AF%95/" class="article-date">
  <time datetime="2021-10-13T04:26:33.000Z" itemprop="datePublished">2021-10-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/10/13/openstack-cinder-nvmf-target-%E6%B5%8B%E8%AF%95/">openstack-cinder nvmf target 测试</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.kubestack.cn/2021/10/13/openstack-cinder-nvmf-target-%E6%B5%8B%E8%AF%95/" data-id="ckup7keh20002uc16hs9635fr" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-CentOS-8-libvirt-7-编译安装" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/09/28/CentOS-8-libvirt-7-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/" class="article-date">
  <time datetime="2021-09-28T03:40:37.000Z" itemprop="datePublished">2021-09-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/09/28/CentOS-8-libvirt-7-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/">CentOS 8-libvirt 7 编译安装</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>基于CentOS 8 x86_64编译安装libvirt 7.2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#dnf --enablerepo&#x3D;PowerTools install gcc cmake libxslt-devel</span><br><span class="line">#dnf --enablerepo&#x3D;PowerTools install meson rpcgen</span><br><span class="line">#wget https:&#x2F;&#x2F;libvirt.org&#x2F;sources&#x2F;libvirt-7.2.0.tar.xz</span><br><span class="line">#tar xvf libvirt-7.2.0.tar.xz</span><br><span class="line">#cd libvirt-7.2.0</span><br><span class="line">#meson build --prefix&#x3D;&#x2F;usr</span><br><span class="line">#ninja -C build</span><br><span class="line">#ninja -C build install</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#libvirtd --version</span><br></pre></td></tr></table></figure>



<p>启动测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;sbin&#x2F;libvirtd --listen</span><br></pre></td></tr></table></figure>

<p>报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2021-09-28 04:27:03.665+0000: 41728: info : libvirt version: 7.2.0</span><br><span class="line">2021-09-28 04:27:03.665+0000: 41728: info : hostname: openstack160.********</span><br><span class="line">2021-09-28 04:27:03.665+0000: 41728: error : virNetTLSContextCheckCertFile:110 : Cannot read CA certificate &#39;&#x2F;etc&#x2F;pki&#x2F;CA&#x2F;cacert.pem&#39;: No such file or directory</span><br><span class="line"></span><br><span class="line">先临时修改了&#x2F;etc&#x2F;libvirt&#x2F;libvirtd.conf 关闭tls</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">error: Failed to start domain &#39;instance-00000018&#39;</span><br><span class="line">error: can&#39;t connect to virtlogd: Failed to connect socket to &#39;&#x2F;var&#x2F;run&#x2F;libvirt&#x2F;virtlogd-sock&#39;: No such file or directory</span><br><span class="line"></span><br><span class="line">解决 ：virtlogd &amp;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h4 id="Troubleshooting"><a href="#Troubleshooting" class="headerlink" title="Troubleshooting"></a>Troubleshooting</h4><ol>
<li>ERROR: Program ‘rpcgen portable-rpcgen’ not found</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install rpcgen</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ERROR: Dependency “gnutls” not found, tried pkgconfig</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install gnutls-devel</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>ERROR: Dependency “libxml-2.0” not found, tried pkgconfig</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install libxml2-devel</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>ERROR: Problem encountered: XDR is required for remote driver</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install libtirpc-devel</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>meson.build:918:2: ERROR: Program ‘rst2html5 rst2html5.py rst2html5-3’ not found<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install rst2html5</span><br></pre></td></tr></table></figure></li>
<li>ERROR: Dependency “libapparmor” not found, tried pkgconfig and cmake<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;rpmfind.net&#x2F;linux&#x2F;opensuse&#x2F;distribution&#x2F;leap&#x2F;15.3&#x2F;repo&#x2F;oss&#x2F;x86_64&#x2F;libapparmor1-2.13.6-1.24.x86_64.rpm</span><br><span class="line">wget https:&#x2F;&#x2F;ftp.lysator.liu.se&#x2F;pub&#x2F;opensuse&#x2F;distribution&#x2F;leap&#x2F;15.3&#x2F;repo&#x2F;oss&#x2F;x86_64&#x2F;libapparmor-devel-2.13.6-1.24.x86_64.rpm</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li>ERROR: C shared or static library ‘attr’ not found<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf --enablerepo&#x3D;powertools install libattr-devel</span><br></pre></td></tr></table></figure></li>
<li>ERROR: C shared or static library ‘audit’ not found<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf --enablerepo&#x3D;powertools install audit-libs audit-libs-devel</span><br></pre></td></tr></table></figure></li>
<li>ERROR: Dependency “bash-completion” not found, tried pkgconfig and cmake<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf --enablerepo&#x3D;powertools install bash-completion</span><br></pre></td></tr></table></figure></li>
<li>ERROR: C shared or static library ‘cap-ng’ not found<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf --enablerepo&#x3D;powertools install libcap-ng-devel</span><br></pre></td></tr></table></figure></li>
<li>ERROR: Dependency “libcurl” not found, tried pkgconfig and cmake<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf --enablerepo&#x3D;powertools install libcurl-devel</span><br></pre></td></tr></table></figure></li>
<li>ERROR: Dependency “libfuse glusterfs-api libiscsi libnl pcap-config libssh libssh2 netcf numa openwsman pciaccess readline libsasl2 libudev wireshark yajl” not found, tried pkgconfig and cmake<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf --enablerepo&#x3D;powertools install fuse-devel glusterfs-api-devel libiscsi-devel libnl3-devel libssh-devel libssh2-devel netcf-devel numactl-devel libwsman-devel libpciaccess-devel readline-devel cyrus-sasl-devel systemd-devel wireshark-devel yajl-devel</span><br></pre></td></tr></table></figure>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.kubestack.cn/2021/09/28/CentOS-8-libvirt-7-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/" data-id="cku40uuy90000ss16ebg94xqc" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/openstack/" rel="tag">openstack</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-openstack-qemu源码编译安装" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/09/17/openstack-qemu%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/" class="article-date">
  <time datetime="2021-09-17T10:51:08.000Z" itemprop="datePublished">2021-09-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/09/17/openstack-qemu%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/">openstack-qemu源码编译安装</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>因原openstack 使用qemu 版本为2.0 太低，考虑升级qemu</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#docker pull centos:8</span><br><span class="line">#docker run --name spdk-vhost --privileged&#x3D;true --network&#x3D;host -v &#x2F;opt&#x2F;tmp:&#x2F;opt&#x2F;tmp -it centos:8 bash</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum -y install python3 python3-devel wget</span><br><span class="line">wget -O &#x2F;etc&#x2F;yum.repos.d&#x2F;CentOS-Base.repo https:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;repo&#x2F;Centos-8.repo</span><br><span class="line">yum -y install epel-release</span><br><span class="line">dnf --enablerepo&#x3D;powertools install ninja-build diffutils  pixman-devel</span><br><span class="line">#dnf --enablerepo&#x3D;powertools install gcc gcc-c++ automake libtool zlib-devel glib2-devel bzip2 bzip2-devel libuuid-devel spice-protocol spice-server-devel usbredir-devel libaio-devel make libmount-devel python3-sphinx cmake</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install ceph-common librbd1-devel</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;download.qemu.org&#x2F;qemu-5.2.0.tar.xz --no-check-certificate</span><br><span class="line">tar xvJf qemu-5.2.0.tar.xz</span><br><span class="line">cd qemu-5.2.0</span><br><span class="line">.&#x2F;configure --prefix&#x3D;&#x2F;usr&#x2F; --enable-kvm --enable-rbd</span><br><span class="line">make -j8</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -sf &#x2F;usr&#x2F;bin&#x2F;qemu-system-x86_64 &#x2F;usr&#x2F;bin&#x2F;qemu-kvm</span><br><span class="line">ln -sf &#x2F;usr&#x2F;bin&#x2F;qemu-system-x86_64 &#x2F;usr&#x2F;libexec&#x2F;qemu-kvm</span><br></pre></td></tr></table></figure>

<h4 id="Troubleshooting"><a href="#Troubleshooting" class="headerlink" title="Troubleshooting"></a>Troubleshooting</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Program dbus-daemon found: YES (&#x2F;bin&#x2F;dbus-daemon)</span><br><span class="line"></span><br><span class="line">..&#x2F;tests&#x2F;qtest&#x2F;meson.build:73:2: ERROR: No program name specified.</span><br><span class="line"></span><br><span class="line">A full log can be found at &#x2F;usr&#x2F;local&#x2F;src&#x2F;qemu-5.2.0&#x2F;build&#x2F;meson-logs&#x2F;meson-log.txt</span><br><span class="line"></span><br><span class="line">ERROR: meson setup failed</span><br></pre></td></tr></table></figure>
<p>解决</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.kubestack.cn/2021/09/17/openstack-qemu%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/" data-id="cktpm2y6a000184164g1q3mmz" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/openstack/" rel="tag">openstack</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-openstack-qemu不支持自定义内存分配" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/09/17/openstack-qemu%E4%B8%8D%E6%94%AF%E6%8C%81%E8%87%AA%E5%AE%9A%E4%B9%89%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D/" class="article-date">
  <time datetime="2021-09-17T07:23:55.000Z" itemprop="datePublished">2021-09-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/09/17/openstack-qemu%E4%B8%8D%E6%94%AF%E6%8C%81%E8%87%AA%E5%AE%9A%E4%B9%89%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D/">openstack-qemu不支持自定义内存分配</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>qemu 启动基于vhost-user disk虚拟机 , 报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(process:96671): GLib-WARNING **: 15:17:23.577: gmem.c:489: custom memory allocation vtable not supported</span><br></pre></td></tr></table></figure>

<p>启动命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">  --enable-kvm \</span><br><span class="line">  -cpu host -smp 8,sockets&#x3D;8,cores&#x3D;1,threads&#x3D;1 \</span><br><span class="line">  -m 2G -object memory-backend-file,id&#x3D;mem0,size&#x3D;2G,mem-path&#x3D;&#x2F;dev&#x2F;hugepages,share&#x3D;on -numa node,memdev&#x3D;mem0 \</span><br><span class="line">  -chardev socket,id&#x3D;spdk_vhost_scsi0,path&#x3D;&#x2F;etc&#x2F;libvirt&#x2F;qemu&#x2F;spdk&#x2F;vhost.0 \</span><br><span class="line">  -device vhost-user-scsi-pci,id&#x3D;scsi0,chardev&#x3D;spdk_vhost_scsi0 \</span><br><span class="line">  -vnc 10.224.130.52:1</span><br></pre></td></tr></table></figure>

<p>环境</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">qemu-kvm-ev-2.12.0-44.1.el7_8.1.x86_64</span><br><span class="line">libvirt-client-4.5.0-1.el7.centos.x86_64</span><br></pre></td></tr></table></figure>

<p>经过谷歌搜索后，发现应该是qemu版本的问题，当前环境qemu的版本为2.0</p>
<p><a target="_blank" rel="noopener" href="https://bugzilla.redhat.com/show_bug.cgi?id=1594304">https://bugzilla.redhat.com/show_bug.cgi?id=1594304</a> 显示的结果来看，应该是bug问题。建议升级qemu版本。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.kubestack.cn/2021/09/17/openstack-qemu%E4%B8%8D%E6%94%AF%E6%8C%81%E8%87%AA%E5%AE%9A%E4%B9%89%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D/" data-id="cktpm2y6c00058416espm1xgw" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/openstack/" rel="tag">openstack</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-es-创建索引" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/09/15/es-%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95/" class="article-date">
  <time datetime="2021-09-15T08:58:42.000Z" itemprop="datePublished">2021-09-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/09/15/es-%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95/">es-创建索引</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>elasticsearch 创建索引</p>
<p>PUT /myIndex</p>
<p>传入json</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"> &quot;settings&quot;:&#123;</span><br><span class="line"></span><br><span class="line">   &quot;number_of_shards&quot;: 5,</span><br><span class="line"></span><br><span class="line">   &quot;number_of_replicas&quot;: 1</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.kubestack.cn/2021/09/15/es-%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95/" data-id="cktpm2y6b000384162mrp7v4o" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/" rel="tag">大数据</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Linux-内存不释放-Used与实际使用不符" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/09/15/Linux-%E5%86%85%E5%AD%98%E4%B8%8D%E9%87%8A%E6%94%BE-Used%E4%B8%8E%E5%AE%9E%E9%99%85%E4%BD%BF%E7%94%A8%E4%B8%8D%E7%AC%A6/" class="article-date">
  <time datetime="2021-09-15T08:30:35.000Z" itemprop="datePublished">2021-09-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/09/15/Linux-%E5%86%85%E5%AD%98%E4%B8%8D%E9%87%8A%E6%94%BE-Used%E4%B8%8E%E5%AE%9E%E9%99%85%E4%BD%BF%E7%94%A8%E4%B8%8D%E7%AC%A6/">Linux-内存不释放,Used与实际使用不符</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>一台服务器，free -g 查看used 200多G ，可是ps查看进程占用内存，最多也就占用几十G，什么鬼？</p>
<p>检查主机上大页缓存设置：</p>
<p>sysctl -a | grep nr_hugepages</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vm.nr_hugepages &#x3D; 300</span><br><span class="line">vm.nr_hugepages_mempolicy &#x3D; 300</span><br></pre></td></tr></table></figure>



<p>发现居然配置了大页内存</p>
<p>于是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#vi &#x2F;etc&#x2F;sysctl.conf</span><br><span class="line"></span><br><span class="line">vm.nr_hugepages &#x3D; 0</span><br><span class="line">vm.nr_hugepages_mempolicy &#x3D; 0</span><br></pre></td></tr></table></figure>



<p>恢复正常了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">              total        used        free      shared  buff&#x2F;cache   available</span><br><span class="line">Mem:            509          37         467           0           4         431</span><br><span class="line">Swap:             3           0           3</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.kubestack.cn/2021/09/15/Linux-%E5%86%85%E5%AD%98%E4%B8%8D%E9%87%8A%E6%94%BE-Used%E4%B8%8E%E5%AE%9E%E9%99%85%E4%BD%BF%E7%94%A8%E4%B8%8D%E7%AC%A6/" data-id="cktpm2y6100008416gksc7vr1" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-openstack-服务连接mysql报错" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/09/14/openstack-%E6%9C%8D%E5%8A%A1%E8%BF%9E%E6%8E%A5mysql%E6%8A%A5%E9%94%99/" class="article-date">
  <time datetime="2021-09-14T04:23:53.000Z" itemprop="datePublished">2021-09-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/09/14/openstack-%E6%9C%8D%E5%8A%A1%E8%BF%9E%E6%8E%A5mysql%E6%8A%A5%E9%94%99/">openstack-服务连接mysql报错</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>openstack集群nova/neutron等组件，经常报mysql lost connection 错误，非常烦人，具体报错如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">(Background on this error at: http:&#x2F;&#x2F;sqlalche.me&#x2F;e&#x2F;e3q8)</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines Traceback (most recent call last):</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines   File &quot;&#x2F;var&#x2F;lib&#x2F;kolla&#x2F;venv&#x2F;lib&#x2F;python2.7&#x2F;site-packages&#x2F;oslo_db&#x2F;sqlalchemy&#x2F;engines.py&quot;, line 73, in _connect_ping_listener</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines     connection.scalar(select([1]))</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines   File &quot;&#x2F;var&#x2F;lib&#x2F;kolla&#x2F;venv&#x2F;lib64&#x2F;python2.7&#x2F;site-packages&#x2F;sqlalchemy&#x2F;engine&#x2F;base.py&quot;, line 920, in scalar</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines     return self.execute(object_, *multiparams, **params).scalar()</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines   File &quot;&#x2F;var&#x2F;lib&#x2F;kolla&#x2F;venv&#x2F;lib64&#x2F;python2.7&#x2F;site-packages&#x2F;sqlalchemy&#x2F;engine&#x2F;base.py&quot;, line 988, in execute</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines     return meth(self, multiparams, params)</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines   File &quot;&#x2F;var&#x2F;lib&#x2F;kolla&#x2F;venv&#x2F;lib64&#x2F;python2.7&#x2F;site-packages&#x2F;sqlalchemy&#x2F;sql&#x2F;elements.py&quot;, line 287, in _execute_on_connection</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines     return connection._execute_clauseelement(self, multiparams, params)</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines   File &quot;&#x2F;var&#x2F;lib&#x2F;kolla&#x2F;venv&#x2F;lib64&#x2F;python2.7&#x2F;site-packages&#x2F;sqlalchemy&#x2F;engine&#x2F;base.py&quot;, line 1107, in _execute_clauseelement</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines     distilled_params,</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines   File &quot;&#x2F;var&#x2F;lib&#x2F;kolla&#x2F;venv&#x2F;lib64&#x2F;python2.7&#x2F;site-packages&#x2F;sqlalchemy&#x2F;engine&#x2F;base.py&quot;, line 1248, in _execute_context</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines     e, statement, parameters, cursor, context</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines   File &quot;&#x2F;var&#x2F;lib&#x2F;kolla&#x2F;venv&#x2F;lib64&#x2F;python2.7&#x2F;site-packages&#x2F;sqlalchemy&#x2F;engine&#x2F;base.py&quot;, line 1464, in _handle_dbapi_exception</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines     util.raise_from_cause(newraise, exc_info)</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines   File &quot;&#x2F;var&#x2F;lib&#x2F;kolla&#x2F;venv&#x2F;lib64&#x2F;python2.7&#x2F;site-packages&#x2F;sqlalchemy&#x2F;util&#x2F;compat.py&quot;, line 398, in raise_from_cause</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines     reraise(type(exception), exception, tb&#x3D;exc_tb, cause&#x3D;cause)</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines   File &quot;&#x2F;var&#x2F;lib&#x2F;kolla&#x2F;venv&#x2F;lib64&#x2F;python2.7&#x2F;site-packages&#x2F;sqlalchemy&#x2F;engine&#x2F;base.py&quot;, line 1244, in _execute_context</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines     cursor, statement, parameters, context</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines   File &quot;&#x2F;var&#x2F;lib&#x2F;kolla&#x2F;venv&#x2F;lib64&#x2F;python2.7&#x2F;site-packages&#x2F;sqlalchemy&#x2F;engine&#x2F;default.py&quot;, line 552, in do_execute</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines     cursor.execute(statement, parameters)</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines   File &quot;&#x2F;var&#x2F;lib&#x2F;kolla&#x2F;venv&#x2F;lib&#x2F;python2.7&#x2F;site-packages&#x2F;pymysql&#x2F;cursors.py&quot;, line 170, in execute</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines     result &#x3D; self._query(query)</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines   File &quot;&#x2F;var&#x2F;lib&#x2F;kolla&#x2F;venv&#x2F;lib&#x2F;python2.7&#x2F;site-packages&#x2F;pymysql&#x2F;cursors.py&quot;, line 328, in _query</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines     conn.query(q)</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines   File &quot;&#x2F;var&#x2F;lib&#x2F;kolla&#x2F;venv&#x2F;lib&#x2F;python2.7&#x2F;site-packages&#x2F;pymysql&#x2F;connections.py&quot;, line 517, in query</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines     self._affected_rows &#x3D; self._read_query_result(unbuffered&#x3D;unbuffered)</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines   File &quot;&#x2F;var&#x2F;lib&#x2F;kolla&#x2F;venv&#x2F;lib&#x2F;python2.7&#x2F;site-packages&#x2F;pymysql&#x2F;connections.py&quot;, line 732, in _read_query_result</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines     result.read()</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines   File &quot;&#x2F;var&#x2F;lib&#x2F;kolla&#x2F;venv&#x2F;lib&#x2F;python2.7&#x2F;site-packages&#x2F;pymysql&#x2F;connections.py&quot;, line 1075, in read</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines     first_packet &#x3D; self.connection._read_packet()</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines   File &quot;&#x2F;var&#x2F;lib&#x2F;kolla&#x2F;venv&#x2F;lib&#x2F;python2.7&#x2F;site-packages&#x2F;pymysql&#x2F;connections.py&quot;, line 657, in _read_packet</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines     packet_header &#x3D; self._read_bytes(4)</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines   File &quot;&#x2F;var&#x2F;lib&#x2F;kolla&#x2F;venv&#x2F;lib&#x2F;python2.7&#x2F;site-packages&#x2F;pymysql&#x2F;connections.py&quot;, line 707, in _read_bytes</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines     CR.CR_SERVER_LOST, &quot;Lost connection to MySQL server during query&quot;)</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines DBConnectionError: (pymysql.err.OperationalError) (2013, &#39;Lost connection to MySQL server during query&#39;)</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines [SQL: SELECT 1]</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines (Background on this error at: http:&#x2F;&#x2F;sqlalche.me&#x2F;e&#x2F;e3q8)</span><br><span class="line">2021-09-08 18:28:05.866 132 ERROR oslo_db.sqlalchemy.engines</span><br><span class="line">2021-09-08 18:28:06.035 132 ERROR oslo_db.sqlalchemy.engines [req-a50d7dba-7060-4983-932f-9a6fd1105b3a - - - - -] Database connection was found disconnected; reconnecting: DBConnectionError: (pymysql.err.OperationalError) (2013, &#39;Lost connection to MySQL server during query&#39;)</span><br></pre></td></tr></table></figure>

<p>这是什么原因呢？ 分析如下：</p>
<p>​    从报错信息能看到是查询时和数据库mysql丢了连接？ 为什么？ </p>
<p>因为openstack组件连接数据库使用oslo_db，封装的基于sqlalchemy的连接池，所以怀疑是连接池里的连接没有回收，导致使用了过期的连接。</p>
<p>上代码：</p>
<p>#vi /var/lib/kolla/venv/lib/python2.7/site-packages/oslo_db/options.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cfg.IntOpt(</span><br><span class="line">        &#39;connection_recycle_time&#39;,</span><br><span class="line">        default&#x3D;3600,</span><br><span class="line">        deprecated_opts&#x3D;[</span><br><span class="line">            cfg.DeprecatedOpt(&#39;idle_timeout&#39;,</span><br><span class="line">                              group&#x3D;&quot;DATABASE&quot;),</span><br><span class="line">            cfg.DeprecatedOpt(&#39;idle_timeout&#39;,</span><br><span class="line">                              group&#x3D;&quot;database&quot;),</span><br><span class="line">            cfg.DeprecatedOpt(&#39;sql_idle_timeout&#39;,</span><br><span class="line">                              group&#x3D;&#39;DEFAULT&#39;),</span><br><span class="line">            cfg.DeprecatedOpt(&#39;sql_idle_timeout&#39;,</span><br><span class="line">                              group&#x3D;&#39;DATABASE&#39;),</span><br><span class="line">            cfg.DeprecatedOpt(&#39;idle_timeout&#39;,</span><br><span class="line">                              group&#x3D;&#39;sql&#39;)</span><br><span class="line">        ],</span><br><span class="line">        help&#x3D;&#39;Connections which have been present in the connection &#39;</span><br><span class="line">             &#39;pool longer than this number of seconds will be replaced &#39;</span><br><span class="line">             &#39;with a new one the next time they are checked out from &#39;</span><br><span class="line">             &#39;the pool.&#39;),</span><br></pre></td></tr></table></figure>

<p>默认回收时间3600s， 但是我的mysql wait_time 为 1800s，所以只需mysql wait_timeout 大于回收时间就行拉</p>
<p>done~</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.kubestack.cn/2021/09/14/openstack-%E6%9C%8D%E5%8A%A1%E8%BF%9E%E6%8E%A5mysql%E6%8A%A5%E9%94%99/" data-id="cktpm2y6v000784164ftq9hr4" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/openstack/" rel="tag">openstack</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-elastic-panic-elastic-Error-all-shards-failed" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/09/13/elastic-panic-elastic-Error-all-shards-failed/" class="article-date">
  <time datetime="2021-09-13T10:03:33.000Z" itemprop="datePublished">2021-09-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/09/13/elastic-panic-elastic-Error-all-shards-failed/">elastic-Error all shards failed</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>第一次尝试使用 elastics的go sdk “github.com/olivere/elastic” ，有go版本的真不错，</p>
<p>不料却报错了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">panic: elastic: Error 400 (Bad Request): all shards failed [type&#x3D;search_phase_execution_exception]</span><br></pre></td></tr></table></figure>

<p>上代码吧</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">	&quot;context&quot;</span><br><span class="line">	&quot;elastic-analysis-go&#x2F;es&quot;</span><br><span class="line">	&quot;fmt&quot;</span><br><span class="line">	&quot;github.com&#x2F;olivere&#x2F;elastic&quot;</span><br><span class="line">)</span><br><span class="line">var (</span><br><span class="line">	IndexName &#x3D; &quot;openstack_error_logs&quot;</span><br><span class="line">)</span><br><span class="line">func main()&#123;</span><br><span class="line">	ctx :&#x3D; context.Background()</span><br><span class="line">	_ &#x3D; es.CreateClient(&quot;http:&#x2F;&#x2F;10.224.144.15:9011&quot;, &quot;USERNAME&quot;, &quot;PASSWORD&quot;)</span><br><span class="line">	&#x2F;&#x2F;create terms agg order by openstack region</span><br><span class="line">	aggs :&#x3D; elastic.NewValueCountAggregation().Field(&quot;programname&quot;)</span><br><span class="line"></span><br><span class="line">	searchResult,err :&#x3D; es.EsClient.Search().</span><br><span class="line">						Index(IndexName).</span><br><span class="line">		Query(elastic.NewMatchAllQuery()). &#x2F;&#x2F; 设置查询条件</span><br><span class="line">		Aggregation(&quot;total&quot;, aggs). &#x2F;&#x2F; 设置聚合条件，并为聚合条件设置一个名字</span><br><span class="line">		Size(0).</span><br><span class="line">		Do(ctx)</span><br><span class="line">	if err !&#x3D; nil &#123;</span><br><span class="line">		panic(err)</span><br><span class="line">	&#125;</span><br><span class="line">	&#x2F;&#x2F; 使用ValueCount函数和前面定义的聚合条件名称，查询结果</span><br><span class="line">	agg, found :&#x3D; searchResult.Aggregations.ValueCount(&quot;total&quot;)</span><br><span class="line">	if found &#123;</span><br><span class="line">		&#x2F;&#x2F; 打印结果，注意：这里使用的是取值运算符</span><br><span class="line">		fmt.Println(*agg.Value)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="原因分析："><a href="#原因分析：" class="headerlink" title="原因分析："></a>原因分析：</h4><p>当使用到Field 精准匹配相关的查询时，所以查询的关键字在es上的类型，必须是keyword而不能是text，比如你的搜索条件是 ”programname”:”neutron”,那么该programname 字段的es类型得是keyword，而不能是text<br>改成使用 elastic.NewValueCountAggregation().Field(“programname.keyword”) 就可以了</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.kubestack.cn/2021/09/13/elastic-panic-elastic-Error-all-shards-failed/" data-id="cktpm4ftt0000os16360udly4" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/elastic/" rel="tag">elastic</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-spdk-基于spdk-vhost-qemu启动虚机" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/09/10/spdk-%E5%9F%BA%E4%BA%8Espdk-vhost-qemu%E5%90%AF%E5%8A%A8%E8%99%9A%E6%9C%BA/" class="article-date">
  <time datetime="2021-09-10T07:40:52.000Z" itemprop="datePublished">2021-09-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/09/10/spdk-%E5%9F%BA%E4%BA%8Espdk-vhost-qemu%E5%90%AF%E5%8A%A8%E8%99%9A%E6%9C%BA/">spdk-基于spdk vhost qemu启动虚机</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>qemu启动虚机，driver使用基于spdk的vhost-user-scsi技术， bdev backend为ceph rbd</p>
<p>创建vhost device (上文创建rbd dev名称为Ceph0)</p>
<h5 id="virtio-blk"><a href="#virtio-blk" class="headerlink" title="virtio-blk"></a>virtio-blk</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#scripts&#x2F;rpc.py vhost_create_blk_controller --cpumask 0x1 vhost.1 Ceph1</span><br><span class="line">#scripts&#x2F;rpc.py bdev_virtio_attach_controller --dev-type blk --trtype user --traddr &#x2F;opt&#x2F;tmp&#x2F;vhost.1 --vq-count 2 --vq-size 512 VirtioBlk1</span><br></pre></td></tr></table></figure>



<h5 id="virtio-scsi"><a href="#virtio-scsi" class="headerlink" title="virtio-scsi"></a>virtio-scsi</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#scripts&#x2F;rpc.py vhost_create_scsi_controller --cpumask 0x1 vhost.0</span><br><span class="line">#scripts&#x2F;rpc.py vhost_scsi_controller_add_target vhost.0 0 Ceph0</span><br></pre></td></tr></table></figure>



<h5 id="启动虚拟机"><a href="#启动虚拟机" class="headerlink" title="启动虚拟机"></a>启动虚拟机</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;local&#x2F;qemu42&#x2F;bin&#x2F;qemu-system-x86_64    --enable-kvm   \</span><br><span class="line">-cpu host -smp 4,sockets&#x3D;4,cores&#x3D;1,threads&#x3D;1   \</span><br><span class="line">-m 1G -object memory-backend-file,id&#x3D;mem0,size&#x3D;1G,mem-path&#x3D;&#x2F;dev&#x2F;hugepages,share&#x3D;on \</span><br><span class="line">-numa node,memdev&#x3D;mem0   \</span><br><span class="line">-drive file&#x3D;&#x2F;opt&#x2F;a0c4f799-aecf-4ebd-af51-03b2f2f14c5a.qcow2,if&#x3D;none,id&#x3D;disk   \</span><br><span class="line">-device ide-hd,drive&#x3D;disk,bootindex&#x3D;0   \</span><br><span class="line">-chardev socket,id&#x3D;spdk_vhost_scsi0,path&#x3D;&#x2F;opt&#x2F;tmp&#x2F;vhost.0   \</span><br><span class="line">-device vhost-user-scsi-pci,id&#x3D;scsi0,chardev&#x3D;spdk_vhost_scsi0,bootindex&#x3D;1  \</span><br><span class="line">-vnc 0.0.0.0:3 \</span><br><span class="line">-device virtio-net-pci,netdev&#x3D;net0 -netdev tap,id&#x3D;net0,ifname&#x3D;tap0,script&#x3D;no,downscript&#x3D;no</span><br></pre></td></tr></table></figure>

<h4 id="Troubleshooting"><a href="#Troubleshooting" class="headerlink" title="Troubleshooting"></a>Troubleshooting</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">libvirt 貌似只支持管理qemu vhost-user-blk方式，不支持vhost-user-scsi方式</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="cinder"><a href="#cinder" class="headerlink" title="cinder"></a>cinder</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cinder type-create sata_high_io</span><br><span class="line">cinder type-key sata_high_io set volume_backend_name&#x3D;rbd-1</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.kubestack.cn/2021/09/10/spdk-%E5%9F%BA%E4%BA%8Espdk-vhost-qemu%E5%90%AF%E5%8A%A8%E8%99%9A%E6%9C%BA/" data-id="ckte5vgp80001dw165h9ef50n" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/spdk/" rel="tag">spdk</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/3/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ELK/" rel="tag">ELK</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/django/" rel="tag">django</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/elastic/" rel="tag">elastic</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/etcd/" rel="tag">etcd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go/" rel="tag">go</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/grpc/" rel="tag">grpc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iptables/" rel="tag">iptables</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kata/" rel="tag">kata</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kube-ovn/" rel="tag">kube-ovn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubernetes/" rel="tag">kubernetes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mariadb/" rel="tag">mariadb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openstack/" rel="tag">openstack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spdk/" rel="tag">spdk</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/" rel="tag">云计算</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%85%B3%E4%BA%8E%E4%BD%9C%E8%80%85/" rel="tag">关于作者</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/" rel="tag">大数据</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%96%87%E5%AD%A6%E7%94%9F%E6%B4%BB/" rel="tag">文学生活</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E5%AE%89%E5%85%A8/" rel="tag">漏洞安全</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/" rel="tag">虚拟化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" rel="tag">面试题</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/ELK/" style="font-size: 10px;">ELK</a> <a href="/tags/Linux/" style="font-size: 18px;">Linux</a> <a href="/tags/django/" style="font-size: 10px;">django</a> <a href="/tags/docker/" style="font-size: 13px;">docker</a> <a href="/tags/elastic/" style="font-size: 10px;">elastic</a> <a href="/tags/etcd/" style="font-size: 10px;">etcd</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/go/" style="font-size: 19px;">go</a> <a href="/tags/grpc/" style="font-size: 11px;">grpc</a> <a href="/tags/iptables/" style="font-size: 10px;">iptables</a> <a href="/tags/kata/" style="font-size: 15px;">kata</a> <a href="/tags/kube-ovn/" style="font-size: 10px;">kube-ovn</a> <a href="/tags/kubernetes/" style="font-size: 17px;">kubernetes</a> <a href="/tags/linux/" style="font-size: 16px;">linux</a> <a href="/tags/mariadb/" style="font-size: 10px;">mariadb</a> <a href="/tags/mysql/" style="font-size: 14px;">mysql</a> <a href="/tags/openstack/" style="font-size: 20px;">openstack</a> <a href="/tags/python/" style="font-size: 12px;">python</a> <a href="/tags/spdk/" style="font-size: 13px;">spdk</a> <a href="/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/" style="font-size: 10px;">云计算</a> <a href="/tags/%E5%85%B3%E4%BA%8E%E4%BD%9C%E8%80%85/" style="font-size: 10px;">关于作者</a> <a href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/" style="font-size: 10px;">大数据</a> <a href="/tags/%E6%96%87%E5%AD%A6%E7%94%9F%E6%B4%BB/" style="font-size: 10px;">文学生活</a> <a href="/tags/%E6%BC%8F%E6%B4%9E%E5%AE%89%E5%85%A8/" style="font-size: 10px;">漏洞安全</a> <a href="/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/" style="font-size: 15px;">虚拟化</a> <a href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" style="font-size: 10px;">面试题</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">August 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/10/20/openstack-ceph-auth%E5%88%9B%E5%BB%BA%E8%B4%A6%E5%8F%B7/">openstack-ceph auth创建账号</a>
          </li>
        
          <li>
            <a href="/2021/10/19/%E5%B0%8F%E7%99%BD%E8%A7%A3%E8%AF%B4%E4%B9%8BDocker%E5%AE%B9%E5%99%A8%E5%85%A5%E9%97%A8/">小白解说之Docker容器入门</a>
          </li>
        
          <li>
            <a href="/2021/10/19/%E5%B0%8F%E7%99%BD%E8%A7%A3%E8%AF%B4%E4%B9%8BOpenStack%E5%85%A5%E9%97%A8/">小白解说之OpenStack</a>
          </li>
        
          <li>
            <a href="/2021/10/19/%E5%B0%8F%E7%99%BD%E8%A7%A3%E8%AF%B4%E4%B9%8BKataContainer%E5%85%A5%E9%97%A8/">小白解说之KataContainer</a>
          </li>
        
          <li>
            <a href="/2021/10/19/%E5%B0%8F%E7%99%BD%E8%A7%A3%E8%AF%B4%E4%B9%8BKubernetes%E5%85%A5%E9%97%A8/">小白解说之Kubernetes入门</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 Tonyzhang1989<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>